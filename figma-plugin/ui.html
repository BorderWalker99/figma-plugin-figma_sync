<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iPhone æˆªå›¾åŒæ­¥ Â· Apple é£æ ¼</title>
  <style>
    /*========================
      Apple-like Visual System
    ========================*/
    :root {
      --bg: #f5f5f7;
      /* macOS / iOS background gray */
      --surface: #ffffff;
      /* card surface */
      --text: #000000;
      /* primary text */
      --subtext: #6e6e73;
      /* secondary text */
      --separator: #e5e5ea;
      /* separator lines */
      --accent: #0a84ff;
      /* iOS system blue */
      --accent-hover: #0066d6;
      /* hover blue */
      --success-bg: #e6f7ec0a;
      --success-fg: #1d7a41;
      --warn-bg: #fff6e60a;
      --warn-fg: #9f5b00;
      --info-bg: #e7f1ff0a;
      --info-fg: #0b66c3;
      --danger: #ff3b30;
      --radius: 12px;
      /* rounded corners */
      --radius-lg: 16px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, .06), 0 1px 1px rgba(0, 0, 0, .04);
      --shadow-md: 0 10px 30px rgba(0, 0, 0, .08);
      --shadow-focus: 0 0 0 4px rgba(10, 132, 255, .18);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #000000;
        --surface: #1c1c1e;
        --text: #ffffff;
        --subtext: #9a9aa0;
        --separator: #2c2c2e;
        --accent: #0a84ff;
        --accent-hover: #0a6ed1;
        --success-bg: rgba(52, 199, 89, 0.2);
        --success-fg: #34c759;
        --warn-bg: rgba(255, 159, 10, .2);
        --warn-fg: #ff9f0a;
        --info-bg: rgba(10, 132, 255, .2);
        --info-fg: #0a84ff;
        --danger: #ff453a;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, .5);
        --shadow-md: 0 10px 30px rgba(0, 0, 0, .6);
      }
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: auto;
      min-height: 0;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      letter-spacing: .02em;
    }

    /* App Frame */
    .app {
      max-width: 880px;
      margin: 32px auto;
      padding: 0 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* æœ€å°åŒ–çŠ¶æ€ */
    .app.minimized .mode-selection,
    .app.minimized .work-area {
      display: none;
    }

    .app.minimized {
      margin: 0;
      padding: 0;
      gap: 0;
    }

    .app.minimized .toolbar {
      margin: 0;
      border-radius: 0;
      border-left: none;
      border-right: none;
      border-top: none;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      background: var(--surface);
      border: 1px solid var(--separator);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      z-index: 2;
      backdrop-filter: saturate(180%) blur(20px);
    }

    .title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 17px;
      flex-wrap: wrap;
    }

    .subtitle-top {
      color: var(--subtext);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pill {
      padding: 6px 10px;
      border: 1px solid var(--separator);
      border-radius: 999px;
      font-size: 12px;
      color: var(--subtext);
    }

    /* Card */
    .card {
      background: var(--surface);
      border: 1px solid var(--separator);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
    }

    .section {
      padding: 20px;
    }

    .section+.section {
      border-top: 1px solid var(--separator);
    }

    /* Mode selection */
    .mode-selection {
      display: block;
    }

    .mode-selection.hidden {
      display: none;
    }

    .mode-head {
      padding: 20px;
    }

    .modeTitleContainer {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 17px;
      flex-wrap: wrap;
    }

    #modeTitle {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #modeTitle .mode-icon {
      width: 20px;
      height: 20px;
      margin-bottom: 0;
    }

    .mode-subtitle {
      font-size: 13px;
      color: var(--subtext);
    }

    .mode-grid {
      padding: 0px 20px 20px 20px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 640px) {
      .mode-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .mode-button {
      width: 100%;
      padding: 16px;
      border: 1px solid var(--separator);
      border-radius: var(--radius);
      cursor: pointer;
      transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease, background .16s ease;
      background: linear-gradient(180deg,
          color-mix(in srgb, var(--surface) 90%, white 10%) 0%,
          color-mix(in srgb, var(--surface) 90%, white 10%) 100%);
      text-align: left;
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }

    .mode-button:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 24px rgba(10, 132, 255, .12);
      transform: translateY(-1px);
    }

    .mode-button:active {
      transform: translateY(0);
    }

    .mode-button:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }

    .mode-button.selected {
      border-color: var(--accent);
      background: linear-gradient(180deg,
          color-mix(in srgb, var(--accent) 8%, var(--surface) 92%) 0%,
          color-mix(in srgb, var(--accent) 8%, var(--surface) 92%) 100%);
      box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.15), var(--shadow-sm);
    }

    .mode-button.selected:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.2), 0 8px 24px rgba(10, 132, 255, .12);
    }

    .mode-icon {
      width: 68px;
      height: 68px;
      position: absolute;
      bottom: -8px;
      right: -8px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.3;
      pointer-events: none;
    }

    .mode-icon img {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: contain;
    }

    .logo-icon {
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      vertical-align: middle;
    }

    .logo-icon svg,
    .logo-icon img {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* å›¾æ ‡ä¸»é¢˜é€‚é… - å•è‰²å›¾æ ‡åœ¨ dark mode ä¸‹åè½¬é¢œè‰² */
    .text-link img,
    .logo-icon img {
      transition: filter 0.2s ease;
    }

    @media (prefers-color-scheme: dark) {
      /* å•è‰²å›¾æ ‡åœ¨ dark mode ä¸‹åè½¬ä¸ºç™½è‰² */
      .text-link img:not(.no-invert),
      .logo-icon img:not(.no-invert) {
        filter: invert(1) brightness(1);
      }
    }

    .mode-button-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
      position: relative;
      z-index: 1;
    }

    .mode-button-desc {
      font-size: 13px;
      color: var(--subtext);
      line-height: 1.55;
      position: relative;
      z-index: 1;
    }

    /* Work area */
    .work-area {
      display: none;
    }

    .work-area.active {
      display: block;
    }

    h2 {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 13px;
      color: var(--subtext);
      margin-bottom: 12px;
    }

    .status {
      padding: 6px 10px;
      border: 1px solid var(--separator);
      border-radius: 999px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--surface);
    }

    .status.connected {
      background: var(--success-bg);
      color: var(--success-fg);
      border-color: transparent;
    }

    .status.waiting {
      background: var(--warn-bg);
      color: var(--warn-fg);
      border-color: transparent;
    }

    .status.syncing {
      background: var(--info-bg);
      color: var(--info-fg);
      border-color: transparent;
    }

    .stats {
      background: var(--surface);
      border: 1px solid var(--separator);
      padding: 16px;
      border-radius: var(--radius);
      margin: 12px 0;
      text-align: center;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--accent);
      letter-spacing: .02em;
    }

    .stat-label {
      font-size: 12px;
      color: var(--subtext);
      margin-top: 4px;
    }

    .info-box {
      background: var(--info-bg);
      color: var(--info-fg);
      border: 1px solid transparent;
      border-left: 4px solid var(--accent);
      padding: 12px 14px;
      margin: 12px 0 6px;
      font-size: 13px;
      border-radius: 10px;
    }

    .info-box strong {
      display: block;
      margin-bottom: 6px;
      color: inherit;
    }

    .log-container {
      margin: 12px 0;
    }

    .log-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: var(--surface);
      border: 1px solid var(--separator);
      border-radius: var(--radius) var(--radius) 0 0;
      cursor: pointer;
      user-select: none;
    }

    .log-header:hover {
      background: var(--bg);
    }

    .log-header-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }

    .log-toggle {
      font-size: 12px;
      color: var(--subtext);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .log-toggle-icon {
      display: inline-block;
      font-size: 10px;
    }

    .log {
      background: var(--surface);
      border: 1px solid var(--separator);
      border-top: none;
      padding: 12px 12px 10px;
      border-radius: 0 0 var(--radius) var(--radius);
      max-height: 220px;
      overflow: auto;
      font-size: 12px;
      line-height: 1.55;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .log-container.collapsed .log {
      max-height: 0;
      padding: 0 12px;
      overflow: hidden;
      border: none;
    }

    /* Buttons */
    button {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--separator);
      border-radius: 11px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      background: var(--surface);
      color: var(--text);
      transition: box-shadow .16s ease, border-color .16s ease, transform .06s ease;
      box-shadow: var(--shadow-sm);
    }

    button:hover {
      border-color: var(--accent);
    }

    button:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }

    button:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background: linear-gradient(180deg, #0a84ff, #0071eb);
      color: #fff;
      border-color: transparent;
    }

    .btn-primary:hover {
      background: linear-gradient(180deg, #0a7aee, #0066d6);
    }

    .btn-success {
      background: linear-gradient(180deg, #34c759, #2cab4d);
      color: #fff;
      border-color: transparent;
      margin-bottom: 12px;
    }

    .btn-success:hover {
      background: linear-gradient(180deg, #30b851, #279b44);
    }

    .btn-danger {
      background: linear-gradient(180deg, #ff3b30, #e13228);
      color: #fff;
      border-color: transparent;
      margin-bottom: 12px;
    }

    .btn-danger:hover {
      background: linear-gradient(180deg, #f4352a, #d12d24);
    }

    .btn-secondary {
      background: linear-gradient(180deg,
          color-mix(in srgb, var(--surface) 90%, white 10%) 0%,
          color-mix(in srgb, var(--surface) 90%, white 10%) 100%);
    }
    

    /* Footer tips */
    .footnote {
      text-align: center;
      color: var(--subtext);
      font-size: 12px;
      margin-top: 12px;
    }

    /* Small helper for hidden elements */
    .hidden {
      display: none !important;
    }

    /* Text link */
    .text-link {
      color: var(--text);
      cursor: pointer;
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
      border-radius: 4px;
      transition: background-color 0.2s ease, opacity 0.2s ease;
    }

    .text-link:hover {
      color: var(--text);
      opacity: 0.7;
      background-color: rgba(0, 0, 0, 0.05);
      text-decoration: none;
    }

    .text-link svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
      flex-shrink: 0;
    }

    .text-link:hover svg {
      fill: currentColor;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      width: min(600px, calc(100% - 24px));
      max-width: calc(100vw - 24px);
      background: var(--surface);
      border: 1px solid var(--separator);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      position: relative;
      padding: 20px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }

    .modal-title {
      font-size: 17px;
      font-weight: 700;
      margin-top: 0;
      margin-bottom: 20px;
    }

    /* Align mode title style with modal title */
    .mode-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .modal-content {
      color: var(--subtext);
      font-size: 13px;
      line-height: 1.6;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 1px solid var(--separator);
      background: var(--surface);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
    }

    .modal-close:hover {
      border-color: var(--accent);
    }
  </style>
  <script>
    // GitHub å›¾ç‰‡èµ„æºåŸºç¡€ URL
    const IMAGE_BASE_URL = 'https://raw.githubusercontent.com/BorderWalker99/figma-plugin-figma_sync/refs/heads/main/images/';
    
    // æ ¹æ®ä¸»é¢˜è·å–äºŒç»´ç ï¼ˆä½¿ç”¨ GitHub URLï¼‰
    function getQRCodeURI(isDark) {
      return {
        google: IMAGE_BASE_URL + (isDark ? 'qr-google-white.png' : 'qr-google-black.png'),
        googleScreenshot: IMAGE_BASE_URL + (isDark ? 'qr-google-white.png' : 'qr-google-black.png'),
        googleAlbum: IMAGE_BASE_URL + (isDark ? 'qr-google-album-white.png' : 'qr-google-album-black.png'),
        icloud: IMAGE_BASE_URL + (isDark ? 'qr-icloud-white.png' : 'qr-icloud-black.png'),
        icloudScreenshot: IMAGE_BASE_URL + (isDark ? 'qr-icloud-white.png' : 'qr-icloud-black.png'),
        icloudAlbum: IMAGE_BASE_URL + (isDark ? 'qr-icloud-album-white.png' : 'qr-icloud-album-black.png')
      };
    }
    

  </script>
  
</head>

<body>
  <div class="app">
    <!-- Top Toolbar -->
    <div class="toolbar card">
      <div class="title">
        <span class="logo-icon"><img class="no-invert" src="https://raw.githubusercontent.com/BorderWalker99/figma-plugin-figma_sync/refs/heads/main/images/logo.svg" alt="Figma Sync" width="20" height="20" /></span>
        Figma Sync <span class="pill" id="toolbarPill">æœªè¿æ¥</span>
      </div>
      <div class="subtitle-top">
        <a id="viewUseCases" class="text-link" title="ä½¿ç”¨ tips">
          <img src="https://raw.githubusercontent.com/BorderWalker99/figma-plugin-figma_sync/refs/heads/main/images/document.svg" alt="ä½¿ç”¨ tips" width="16" height="16" />
        </a>
        <a id="openSettings" class="text-link" title="è®¾ç½®">
          <img src="https://raw.githubusercontent.com/BorderWalker99/figma-plugin-figma_sync/refs/heads/main/images/settings.svg" alt="è®¾ç½®" width="16" height="16" />
        </a>
        <a id="toggleMinimize" class="text-link" title="æœ€å°åŒ–">
          <img id="minimizeIcon" src="https://raw.githubusercontent.com/BorderWalker99/figma-plugin-figma_sync/refs/heads/main/images/minimize.svg" alt="æœ€å°åŒ–" width="16" height="16" />
        </a>
      </div>
    </div>

    <!-- æ¨¡å¼é€‰æ‹©ç•Œé¢ -->
    <div class="mode-selection card" id="modeSelection">
      <div class="mode-head">
        <div class="mode-title">é€‰æ‹©åŒæ­¥æ¨¡å¼</div>
        <div class="mode-subtitle">é€‰æ‹©é€‚åˆçš„å·¥ä½œæ–¹å¼ï¼ŒåŒæ­¥åè‡ªåŠ¨åˆ é™¤æºæ–‡ä»¶ä»¥èŠ‚çœç©ºé—´</div>
      </div>
      <div class="mode-grid">
        <button class="mode-button" id="realtimeBtn" aria-label="é€‰æ‹©å®æ—¶åŒæ­¥æ¨¡å¼">
          <div class="mode-icon"><img class="no-invert" src="https://raw.githubusercontent.com/BorderWalker99/figma-plugin-figma_sync/refs/heads/main/images/mode-realtime.svg" alt="å®æ—¶åŒæ­¥" width="68" height="68" /></div>
          <div class="mode-button-title">å®æ—¶åŒæ­¥æ¨¡å¼</div>
          <div class="mode-button-desc">è‡ªåŠ¨æ£€æµ‹æ–°æˆªå›¾å¹¶ç«‹å³åŒæ­¥åˆ°ç”»æ¿</div>
        </button>

        <button class="mode-button" id="manualBtn" aria-label="é€‰æ‹©æ‰‹åŠ¨åŒæ­¥æ¨¡å¼">
          <div class="mode-icon"><img class="no-invert" src="https://raw.githubusercontent.com/BorderWalker99/figma-plugin-figma_sync/refs/heads/main/images/mode-manual.svg" alt="æ‰‹åŠ¨åŒæ­¥" width="68" height="68" /></div>
          <div class="mode-button-title">æ‰‹åŠ¨åŒæ­¥æ¨¡å¼</div>
          <div class="mode-button-desc">æ‰¹é‡åŒæ­¥å­˜å‚¨çš„æ‰€æœ‰æˆªå›¾</div>
        </button>
      </div>
    </div>

    <!-- å·¥ä½œç•Œé¢ -->
    <div class="work-area card" id="workArea">
      <div class="section">
        <div class="modeTitleContainer">
          <div id="modeTitle">
            <span class="logo-icon"><img class="no-invert" src="https://raw.githubusercontent.com/BorderWalker99/figma-plugin-figma_sync/refs/heads/main/images/logo.svg" alt="Figma Sync" width="20" height="20" /></span>
            Figma Sync
          </div>
          <div id="status" class="status waiting">ç­‰å¾…è¿æ¥</div>
        </div>
        <div class="subtitle" id="modeSubtitle"></div>

        <div class="stats">
          <div class="stat-value" id="count">0</div>
          <div class="stat-label">å·²åŒæ­¥æˆªå›¾</div>
        </div>

        <div class="info-box" id="infoBox"></div>
        <div class="log-container" id="logContainer">
          <div class="log-header" id="logHeader">
            <span class="log-header-title">æ—¥å¿—</span>
            <span class="log-toggle">
              <span class="log-toggle-icon">â–²</span>
              <span id="logToggleText">æ”¶èµ·</span>
            </span>
          </div>
        <div class="log" id="log"></div>
        </div>

        <button class="btn-success" id="syncBtn" style="display:none;">ç«‹å³åŒæ­¥æ‰€æœ‰æˆªå›¾</button>
        <button class="btn-danger" id="stopBtn" style="display:none;">åœæ­¢å®æ—¶åŒæ­¥</button>
        <button class="btn-secondary" id="locateFrameBtn" style="display:none;">å®šä½ç”»æ¿</button>
        <button class="btn-secondary" id="backBtn">è¿”å›é€‰æ‹©æ¨¡å¼</button>

        <!-- <div class="footnote">æç¤ºï¼šæ”¯æŒç³»ç»Ÿæ·±è‰²æ¨¡å¼ Â· âŒ˜/Ctrl + L èšç„¦æ—¥å¿—ï¼ˆæµè§ˆå™¨ï¼‰</div> -->
      </div>
    </div>
  </div>

  <!-- ä½¿ç”¨åœºæ™¯ Modal -->
  <div id="useCaseOverlay" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="useCaseTitle">
    <div class="modal">
      <button id="useCaseClose" class="modal-close" aria-label="å…³é—­">
        âœ•
      </button>
      <h3 id="useCaseTitle" class="modal-title">ä½¿ç”¨ tips</h3>
      <div class="modal-content" id="useCaseContent" style="white-space: normal;">
        <div style="display: flex; flex-direction: column; gap: 16px;">
          <div>
            <div style="font-weight: 600; color: var(--text); margin-bottom: 8px;">1. å¯åŠ¨æœåŠ¡</div>
            <div style="font-size: 12px; color: var(--subtext); line-height: 1.6;">
              æ¯æ¬¡ä½¿ç”¨å‰ï¼Œå‰å¾€å¯åŠ¨å°æ‰“å¼€ç»ˆç«¯ï¼Œåˆ†åˆ«è¿è¡Œä»¥ä¸‹ä¸¤è¡Œå‘½ä»¤:
              <div style="background: var(--surface); padding: 8px 12px; border-radius: 6px; margin-top: 6px; margin-bottom: 6px; font-family: monospace; font-size: 11px; border: 1px solid var(--separator);">
                cd <span style="color: var(--accent);">[FigmaSync-UserPackage æ–‡ä»¶å¤¹è·¯å¾„]</span>
              </div>
              <div style="background: var(--surface); padding: 8px 12px; border-radius: 6px; margin-top: 6px; margin-bottom: 6px; font-family: monospace; font-size: 11px; border: 1px solid var(--separator);">
                npm start
              </div>
              <div style="margin-top: 8px; margin-bottom: 8px;">
                <img src="https://raw.githubusercontent.com/BorderWalker99/figma-plugin-figma_sync/refs/heads/main/images/start-demo.gif" alt="æ­¥éª¤2" style="max-width: 100%; border-radius: 6px; border: 1px solid var(--separator);" />
              </div>
              ä½¿ç”¨æ’ä»¶æœŸé—´ä¿æŒç»ˆç«¯çª—å£æ‰“å¼€ï¼Œä¸è¦å…³é—­ã€‚
            </div>
          </div>
          
          <div>
            <div style="font-weight: 600; color: var(--text); margin-bottom: 8px;">2. é…ç½® iPhone å¿«æ·æŒ‡ä»¤</div>
            <div style="font-size: 12px; color: var(--subtext); line-height: 1.6;">
              <div style="margin-bottom: 12px;">
                æŒ‰éœ€æ‰«æä¸‹æ–¹äºŒç»´ç ä¸‹è½½å¿«æ·æŒ‡ä»¤:
              </div>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                  <img id="qrGoogleScreenshot" alt="Google Drive ç›´æ¥æˆªå›¾ä¸Šä¼ äºŒç»´ç " 
                       style="width: 120px; height: 120px; color: var(--text);">
                  <div style="font-size: 11px; color: var(--subtext); text-align: center;">Google Drive<br>ç›´æ¥æˆªå›¾ä¸Šä¼ </div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                  <img id="qrGoogleAlbum" alt="Google Drive ç›¸å†Œä¸Šä¼ äºŒç»´ç " 
                       style="width: 120px; height: 120px; color: var(--text);">
                  <div style="font-size: 11px; color: var(--subtext); text-align: center;">Google Drive<br>ç›¸å†Œä¸Šä¼  (æ”¯æŒå½•å±)</div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                  <img id="qrIcloudScreenshot" alt="iCloud ç›´æ¥æˆªå›¾ä¸Šä¼ äºŒç»´ç " 
                       style="width: 120px; height: 120px; color: var(--text);">
                  <div style="font-size: 11px; color: var(--subtext); text-align: center;">iCloud<br>ç›´æ¥æˆªå›¾ä¸Šä¼ </div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                  <img id="qrIcloudAlbum" alt="iCloud ç›¸å†Œä¸Šä¼ äºŒç»´ç " 
                       style="width: 120px; height: 120px; color: var(--text);">
                  <div style="font-size: 11px; color: var(--subtext); text-align: center;">iCloud<br>ç›¸å†Œä¸Šä¼  (æ”¯æŒå½•å±)</div>
                </div>
              </div>
              <div style="margin-top: 12px; font-size: 12px; color: var(--subtext); line-height: 2.4;">
                ä½¿ç”¨ Google Drive æ¨¡å¼æ—¶ï¼Œéœ€åœ¨å¿«æ·æŒ‡ä»¤çš„ã€Œè·å–URLå†…å®¹ã€ä¸­å¡«å…¥ <span style="color: var(--accent);">x-user-id</span> (åœ¨ Mac ç»ˆç«¯è¿è¡Œ <code style="background: var(--surface); padding: 6px 10px; margin-left: 4px; margin-right: 4px; border-radius: 4px; font-family: monospace; font-size: 11px; border: 1px solid var(--separator);">./get-user-id.sh</code> è·å–)
              </div>
            </div>
          </div>
  
          <div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- è®¾ç½® Modal -->
  <div id="settingsOverlay" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="modal">
      <button id="settingsClose" class="modal-close" aria-label="å…³é—­">
        âœ•
      </button>
      <h3 id="settingsTitle" class="modal-title">ä¸Šä¼ æ¨¡å¼è®¾ç½®</h3>
      <div class="modal-content" id="settingsContent">
        <div style="margin-bottom: 16px;">
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <button class="mode-button" id="switchToDrive" style="text-align: left; padding: 16px;">
              <div class="mode-icon"><img class="no-invert" src="https://raw.githubusercontent.com/BorderWalker99/figma-plugin-figma_sync/refs/heads/main/images/google.svg" alt="Google Drive" width="68" height="68" /></div>
              <div class="mode-button-title">Google Drive ä¸Šä¼ </div>
              <div class="mode-button-desc">ä¸Šä¼ è‡³ Google Drive å…¬å…±äº‘ï¼Œæ— éœ€ iCloud</div>
            </button>
            <button class="mode-button" id="switchToAliyun" style="text-align: left; padding: 16px;">
              <div class="mode-icon"><img class="no-invert" src="https://raw.githubusercontent.com/BorderWalker99/figma-plugin-figma_sync/refs/heads/main/images/google.svg" alt="é˜¿é‡Œäº‘ OSS" width="68" height="68" /></div>
              <div class="mode-button-title">é˜¿é‡Œäº‘ OSS ä¸Šä¼ </div>
              <div class="mode-button-desc">ä¸Šä¼ è‡³é˜¿é‡Œäº‘ OSSï¼Œé€‚åˆä¸­å›½å¤§é™†ç”¨æˆ·ï¼Œç½‘ç»œæ›´ç¨³å®š</div>
            </button>
            <button class="mode-button" id="switchToIcloud" style="text-align: left; padding: 16px;">
              <div class="mode-icon"><img class="no-invert" src="https://raw.githubusercontent.com/BorderWalker99/figma-plugin-figma_sync/refs/heads/main/images/icloud.svg" alt="iCloud" width="68" height="68" /></div>
              <div class="mode-button-title">iCloud ä¸Šä¼ </div>
              <div class="mode-button-desc">ä¸Šä¼ è‡³ iCloud ä¸ªäººäº‘ï¼Œéœ€æ‰‹æœºç”µè„‘å…±ç”¨ iCloud è´¦å·ä¸”ç©ºé—´å……è¶³</div>
            </button>
          </div>
        </div>
        <div id="switchStatus" style="margin-top: 16px; font-size: 13px; color: var(--subtext);"></div>
        
        <!-- å°ºå¯¸è®¾ç½® -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--separator);">
          <div style="font-size: 17px; font-weight: 700; color: var(--text); margin-bottom: 4px;">
            æˆªå›¾å°ºå¯¸è®¾ç½®
          </div>
          <div style="font-size: 13px; color: var(--subtext); margin-bottom: 20px;">
            è®¾ç½®å›ºå®šå®½é«˜ï¼Œå¦ä¸€è¾¹ä¼šæŒ‰æ¯”ä¾‹è‡ªåŠ¨è®¡ç®—ï¼›ä¸å¡«åˆ™é»˜è®¤å–è®¾å¤‡å±å¹•å°ºå¯¸
          </div>
          <div style="display: flex; gap: 12px; align-items: center;">
            <div style="flex: 1;">
              <label style="display: block; font-size: 12px; color: var(--subtext); margin-bottom: 6px;">å®½åº¦ (px)</label>
              <input type="number" id="imageWidthInput" placeholder="è¯·è¾“å…¥å®½åº¦" 
                     style="width: 100%; padding: 8px 12px; border: 1px solid var(--separator); border-radius: 6px; background: var(--surface); color: var(--text); font-size: 13px;"
                     min="1" step="1">
            </div>
            <div style="flex: 1;">
              <label style="display: block; font-size: 12px; color: var(--subtext); margin-bottom: 6px;">é«˜åº¦ (px)</label>
              <input type="number" id="imageHeightInput" placeholder="è¯·è¾“å…¥é«˜åº¦"
                     style="width: 100%; padding: 8px 12px; border: 1px solid var(--separator); border-radius: 6px; background: var(--surface); color: var(--text); font-size: 13px;"
                     min="1" step="1">
            </div>
          </div>
          <div style="margin-top: 12px; display: flex; gap: 12px;">
            <button id="saveSizeSettings" style="flex: 1; padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer;">
              ä¿å­˜
            </button>
            <button id="clearSizeSettings" style="flex: 1; padding: 8px 16px; background: transparent; color: var(--subtext); border: 1px solid var(--separator); border-radius: 6px; font-size: 13px; cursor: pointer;">
              æ¸…é™¤
            </button>
          </div>
          <div id="sizeSettingsStatus" style="margin-top: 8px; font-size: 12px; color: var(--subtext);"></div>
        </div>
        
        <!-- ç”»æ¿å¸ƒå±€è®¾ç½® -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--separator);">
          <div style="font-size: 17px; font-weight: 700; color: var(--text); margin-bottom: 4px;">
            ç”»æ¿å¸ƒå±€è®¾ç½®
          </div>
          <div style="font-size: 13px; color: var(--subtext); margin-bottom: 20px;">
            è®¾ç½®æ¯è¡Œæ˜¾ç¤ºå¤šå°‘å¼ æˆªå›¾ï¼Œä¸å¡«åˆ™é»˜è®¤ä¸€ç›´æ¨ªç€æ’ï¼ˆä¸æ¢è¡Œï¼‰
          </div>
          <div>
            <label style="display: block; font-size: 12px; color: var(--subtext); margin-bottom: 6px;">æ¯è¡Œæ˜¾ç¤º (å¼ )</label>
            <input type="number" id="frameColumnsInput" placeholder="ä¸å¡«åˆ™ä¸€ç›´æ¨ªç€æ’" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid var(--separator); border-radius: 6px; background: var(--surface); color: var(--text); font-size: 13px;"
                   min="1" step="1">
          </div>
          <div style="margin-top: 12px; display: flex; gap: 12px;">
            <button id="saveLayoutSettings" style="flex: 1; padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer;">
              ä¿å­˜
            </button>
            <button id="clearLayoutSettings" style="flex: 1; padding: 8px 16px; background: transparent; color: var(--subtext); border: 1px solid var(--separator); border-radius: 6px; font-size: 13px; cursor: pointer;">
              æ¸…é™¤
            </button>
          </div>
          <div id="layoutSettingsStatus" style="margin-top: 8px; font-size: 12px; color: var(--subtext);"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== å…¨å±€å˜é‡ ==========
    const SERVER_URL = 'ws://localhost:8888';
    const connectionId = 'sync-session-1';
    
    let ws = null;
    let screenshotCount = 0;
    let manualDragCount = 0; // éœ€è¦æ‰‹åŠ¨å¯¼å…¥çš„æ–‡ä»¶æ•°é‡ï¼ˆMP4 + å¤§äº150MBçš„GIFï¼‰
    let heartbeatTimer = null;
    let currentMode = null; // 'realtime' æˆ– 'manual'
    let currentSyncMode = null; // 'drive'ã€'aliyun'/'oss' æˆ– 'icloud'ï¼Œä»æœåŠ¡å™¨è·å–
    let isMinimized = false; // æ˜¯å¦æœ€å°åŒ–

    // ========== æ—¥å¿—å‡½æ•° ==========
    function log(msg) {
      console.log(msg);
      const logEl = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      logEl.innerHTML = `[${time}] ${msg}\n` + logEl.innerHTML;

      const lines = logEl.innerText.split('\n');
      if (lines.length > 200) {
        // ä¿ç•™å‰ 200 æ¡
        logEl.innerText = lines.slice(0, 200).join('\n');
      }
    }

    // ========== WebSocketè¿æ¥ ==========
    function setToolbarPill(text) {
      const pill = document.getElementById('toolbarPill');
      pill.textContent = text;
    }

    function connect() {
      updateStatus('waiting', 'è¿æ¥ä¸­');
      setToolbarPill('è¿æ¥ä¸­');

      ws = new WebSocket(SERVER_URL + '?id=' + connectionId + '&type=figma');

      ws.onopen = function () {
        log('âœ… å·²è¿æ¥');
        updateStatus('connected', 'å·²è¿æ¥');
        setToolbarPill('å·²è¿æ¥');

        // å¯åŠ¨å¿ƒè·³ï¼ˆä¿ç•™åŠŸèƒ½é€»è¾‘ä¸å˜ï¼‰
        if (heartbeatTimer) clearInterval(heartbeatTimer);
        heartbeatTimer = setInterval(function () {
          if (ws.readyState === 1) {
            ws.send(JSON.stringify({ type: 'ping' }));
          }
        }, 5000);
      };

      ws.onmessage = function (event) {
        var data = JSON.parse(event.data);

        if (data.type === 'pong') { return; }

        if (data.type === 'screenshot') {
          handleScreenshot(data);
        } else if (data.type === 'file-skipped') {
          // æ–‡ä»¶éœ€è¦æ‰‹åŠ¨å¯¼å…¥ï¼ˆMP4/MOV è§†é¢‘æˆ–å¤§äº100MBçš„GIFï¼‰
          manualDragCount++;
          let reasonText = 'GIFè¿‡å¤§';
          if (data.reason === 'mp4' || data.reason === 'video') {
            const ext = (data.filename || '').toLowerCase();
            if (ext.endsWith('.mov')) {
              reasonText = 'MOVè§†é¢‘';
            } else {
              reasonText = 'MP4è§†é¢‘';
            }
          } else if (data.reason === 'gif-too-large') {
            reasonText = 'GIFè¿‡å¤§';
          }
          log(`âš ï¸  ${data.filename} éœ€æ‰‹åŠ¨å¯¼å…¥ï¼ˆ${reasonText}ï¼‰`);
          
          // é€šè¿‡ WebSocket é€šçŸ¥æœåŠ¡å™¨ï¼Œä¸è¦åˆ é™¤æºæ–‡ä»¶ï¼ˆiCloud æ¨¡å¼éœ€è¦ï¼‰
          if (ws && ws.readyState === WebSocket.OPEN) {
            try {
              ws.send(JSON.stringify({
                type: 'screenshot-failed',
                filename: data.filename,
                error: reasonText,
                keepFile: true // æ ‡è®°ä¿ç•™æ–‡ä»¶
              }));
            } catch (error) {
              console.error('å‘é€å¤±è´¥æ¶ˆæ¯å¤±è´¥:', error);
            }
          }
          
          // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºï¼Œåªæ˜¾ç¤ºæ‰‹åŠ¨å¯¼å…¥çš„æ–‡ä»¶æ•°é‡ï¼ˆä¸æ˜¾ç¤ºåŒæ­¥å®Œæˆä¿¡æ¯ï¼‰
          updateStatus('connected', '');
        } else if (data.type === 'manual-sync-complete') {
          // å¦‚æœæœ‰æ–‡ä»¶éœ€è¦æ‰‹åŠ¨å¯¼å…¥ï¼Œä¸æ˜¾ç¤º"åŒæ­¥å®Œæˆ"ï¼Œåªæ˜¾ç¤ºæ‰‹åŠ¨å¯¼å…¥æç¤º
          if (manualDragCount > 0) {
            // æœ‰æ–‡ä»¶éœ€è¦æ‰‹åŠ¨å¯¼å…¥ï¼Œä¸æ˜¾ç¤ºåŒæ­¥å®Œæˆ
            log(`âš ï¸  æœ‰ ${manualDragCount} ä¸ªæ–‡ä»¶éœ€æ‰‹åŠ¨å¯¼å…¥`);
            // å°†çŠ¶æ€ä» syncing æ›´æ–°ä¸º connectedï¼Œæ˜¾ç¤º"éœ€æ‰‹åŠ¨å¯¼å…¥"çš„æç¤º
            // updateStatus('connected', '') ä¼šåœ¨æ²¡æœ‰æ–°çŠ¶æ€æ–‡æœ¬æ—¶è‡ªåŠ¨æ˜¾ç¤ºæ‰‹åŠ¨å¯¼å…¥æç¤º
            updateStatus('connected', '');
            return; // æå‰è¿”å›ï¼Œä¸å¤„ç†åŒæ­¥å®Œæˆæ¶ˆæ¯
          }
          
          // æ²¡æœ‰éœ€è¦æ‰‹åŠ¨å¯¼å…¥çš„æ–‡ä»¶ï¼Œæ­£å¸¸æ˜¾ç¤ºåŒæ­¥å®Œæˆ
          // åªè¦æˆåŠŸåŒæ­¥äº†è‡³å°‘ä¸€å¼ ï¼ˆcount > 0ï¼‰ï¼Œå°±ä¸å¼¹çª—
          // åªæœ‰ç¡®å®æ²¡æœ‰æ–‡ä»¶éœ€è¦åŒæ­¥ï¼ˆcount === 0 ä¸” total === 0ï¼‰æ—¶æ‰å¼¹å‡ºæç¤º
          if (data.count > 0) {
            log(`âœ… åŒæ­¥å®Œæˆï¼š${data.count} å¼ æˆªå›¾`);
            // æ›´æ–°çŠ¶æ€ï¼Œæ˜¾ç¤ºåŒæ­¥å®Œæˆä¿¡æ¯
            updateStatus('connected', 'åŒæ­¥å®Œæˆ å…±' + data.count + 'å¼ ');
          } else if (data.total === 0) {
            // ç¡®å®æ²¡æœ‰æ–‡ä»¶
            log('â„¹ï¸  æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æˆªå›¾');
            alert('æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æˆªå›¾éœ€è¦åŒæ­¥');
            updateStatus('connected', 'åŒæ­¥å®Œæˆ');
          } else {
            // æœ‰æ–‡ä»¶ä½†å¤„ç†å¤±è´¥çš„æƒ…å†µï¼ˆcount === 0 ä½† total > 0ï¼‰
            log(`âš ï¸  åŒæ­¥å®Œæˆï¼Œä½† ${data.total} å¼ æˆªå›¾å¤„ç†å¤±è´¥`);
            updateStatus('connected', 'åŒæ­¥å®Œæˆ');
          }
        } else if (data.type === 'sync-mode-changed') {
          currentSyncMode = data.mode;
          updateSyncModeDisplay();
          log('âœ… ä¸Šä¼ æ¨¡å¼å·²åˆ‡æ¢');
        } else if (data.type === 'sync-mode-info') {
          currentSyncMode = data.mode;
          updateSyncModeDisplay();
        } else if (data.type === 'switch-sync-mode-result') {
          const statusEl = document.getElementById('switchStatus');
          if (data.success) {
            statusEl.textContent = 'âœ… ' + data.message;
            statusEl.style.color = 'var(--success-fg)';
            currentSyncMode = data.mode;
            updateSyncModeDisplay();
            
            // åœæ­¢å®æ—¶æ¨¡å¼å¹¶è¿”å›ä¸»ç•Œé¢
            stopRealtimeSync();
            showModeSelection();
            
            // 2ç§’åå…³é—­è®¾ç½®çª—å£
            setTimeout(() => {
              closeSettings();
            }, 2000);
          } else {
            statusEl.textContent = 'âŒ ' + data.message;
            statusEl.style.color = 'var(--danger)';
          }
        }
      };

      ws.onerror = function () {
        log('âŒ è¿æ¥å¤±è´¥');
        updateStatus('waiting', 'è¿æ¥å¤±è´¥');
        setToolbarPill('è¿æ¥å¤±è´¥');
      };

      ws.onclose = function () {
        log('âš ï¸ è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...');
        updateStatus('waiting', 'è¿æ¥æ–­å¼€');
        setToolbarPill('æœªè¿æ¥');
        if (heartbeatTimer) clearInterval(heartbeatTimer);
        setTimeout(connect, 3000);
      };
    }

    // ä¿å­˜æœ€è¿‘å¤„ç†çš„æ–‡ä»¶çš„ driveFileIdï¼ˆç”¨äºå¤±è´¥æ—¶å–æ¶ˆåˆ é™¤ï¼‰
    let currentDriveFileId = null;

    function handleScreenshot(data) {
      // å…ˆä¸å¢åŠ è®¡æ•°ï¼Œç­‰å¾… Figma å¤„ç†æˆåŠŸåå†å¢åŠ 
      // è¿™æ ·å¯ä»¥é¿å…åœ¨æ–‡ä»¶éœ€è¦æ‰‹åŠ¨å¯¼å…¥æˆ–å¤„ç†å¤±è´¥æ—¶é”™è¯¯åœ°å¢åŠ è®¡æ•°
      log(`ğŸ“¸ ${data.filename || 'æˆªå›¾'}`);

      // ä¿å­˜ driveFileIdï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      currentDriveFileId = data.driveFileId || null;

      try {
      // å‘é€åˆ°Figmaä¸»çº¿ç¨‹
      parent.postMessage({
        pluginMessage: {
          type: 'add-screenshot',
          bytes: data.bytes,
          timestamp: data.timestamp,
          filename: data.filename,
          driveFileId: data.driveFileId // ä¼ é€’ driveFileId ç»™ code.js
        }
      }, '*');
        } catch (error) {
        log('âŒ å¤„ç†å¤±è´¥: ' + error.message);
        console.error('å‘é€å¤±è´¥:', error);
        }

      // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œç«‹å³å‘é€ç¡®è®¤æ¶ˆæ¯
      // ç¡®è®¤æ¶ˆæ¯å°†åœ¨ code.js å¤„ç†æˆåŠŸåå‘é€ï¼ˆåœ¨ screenshot-added æˆåŠŸæ¶ˆæ¯å¤„ç†ä¸­ï¼‰
    }

    // ========== UIæ›´æ–° ==========
    function updateStatus(type, text) {
      const statusEl = document.getElementById('status');
      const pill = document.getElementById('toolbarPill');

      // æ›´æ–°ä¸»çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
      statusEl.className = 'status ' + type;
      
      // ä¼˜å…ˆæ˜¾ç¤ºæ–°ä¼ å…¥çš„çŠ¶æ€æ–‡æœ¬ï¼ˆå®Œå…¨æ›¿æ¢æ—§çŠ¶æ€ï¼‰
      if (text && text !== '') {
        // æœ‰æ–°çŠ¶æ€æ–‡æœ¬æ—¶ï¼Œå®Œå…¨æ˜¾ç¤ºæ–°çŠ¶æ€ï¼Œä¸è¿½åŠ è­¦å‘Š
        // è¿™æ ·å¯ä»¥ç¡®ä¿æ–°çŠ¶æ€èƒ½å¤Ÿæ›¿æ¢æ‰"éœ€æ‰‹åŠ¨å¯¼å…¥"çš„è­¦å‘Š
      statusEl.textContent = text;
        // æ¢å¤é»˜è®¤æ ·å¼ï¼ˆé€šè¿‡CSSç±»è®¾ç½®ï¼‰
        statusEl.style.color = '';
        statusEl.style.background = '';
        statusEl.style.borderColor = '';
      } else if (manualDragCount > 0 && type === 'connected') {
        // æ²¡æœ‰æ–°çŠ¶æ€æ–‡æœ¬ï¼Œä½†æœ‰éœ€è¦æ‰‹åŠ¨å¯¼å…¥çš„æ–‡ä»¶ï¼Œæ˜¾ç¤ºè­¦å‘Š
        const warningText = `éœ€æ‰‹åŠ¨å¯¼å…¥ ${manualDragCount} æ®µå½•å±`;
        statusEl.textContent = warningText;
        // åªä¿®æ”¹é¢œè‰²å’ŒèƒŒæ™¯è‰²ï¼Œå…¶ä»–æ ·å¼ä¿æŒä¸status.connectedä¸€è‡´
        statusEl.style.color = '#ff9500'; // é»„è‰²è­¦ç¤ºè‰²
        statusEl.style.background = 'rgba(255, 149, 0, 0.1)'; // æµ…é»„è‰²èƒŒæ™¯
        statusEl.style.borderColor = 'transparent'; // ä¿æŒä¸status.connectedä¸€è‡´çš„é€æ˜è¾¹æ¡†
      } else {
        // æ²¡æœ‰æ–°çŠ¶æ€æ–‡æœ¬ï¼Œä¹Ÿæ²¡æœ‰éœ€è¦æ‰‹åŠ¨å¯¼å…¥çš„æ–‡ä»¶ï¼Œæ˜¾ç¤ºç©ºæ–‡æœ¬æˆ–é»˜è®¤æ–‡æœ¬
        statusEl.textContent = text || '';
        // æ¢å¤é»˜è®¤æ ·å¼ï¼ˆé€šè¿‡CSSç±»è®¾ç½®ï¼‰
        statusEl.style.color = '';
        statusEl.style.background = '';
        statusEl.style.borderColor = '';
      }

      // åŒæ­¥é¡¶éƒ¨æ ‡ç­¾æ ·å¼ï¼ˆä¿æŒç»¿è‰²ï¼Œä¸å˜é»„è‰²ï¼‰
      if (type === 'connected') {
        pill.textContent = 'å·²è¿æ¥';
        pill.style.background = 'rgba(52, 199, 89, 0.05)';  // ç»¿è‰²èƒŒæ™¯
        pill.style.color = '#1d7a41';       // æ·±ç»¿è‰²æ–‡å­—
        pill.style.borderColor = 'rgba(52, 199, 89, 0.3)';
      } else if (type === 'waiting' || type === 'syncing') {
        pill.textContent = 'æœªè¿æ¥';
        pill.style.background = 'rgba(255, 255, 255, 0.05)';  // ç°è‰²èƒŒæ™¯
        pill.style.color = '#6e6e73';       // ç°è‰²æ–‡å­—
        pill.style.borderColor = 'rgba(255, 255, 255, 0.3)';
      }
    }

    function showWorkArea(mode) {
      currentMode = mode;
      document.getElementById('modeSelection').classList.add('hidden');
      document.getElementById('workArea').classList.add('active');
      
      // è¿›å…¥æ¨¡å¼æ—¶è‡ªåŠ¨æ”¶èµ·æ—¥å¿—
      collapseLog();

      if (mode === 'realtime') {
        document.getElementById('modeTitle').innerHTML = '<span class="mode-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0.00 0.00 512.00 512.00" width="20" height="20"><path fill="#ffcf4a" d="M 400.39 0.00 Q 406.46 1.42 407.76 6.51 Q 408.80 10.63 407.10 13.33 Q 354.52 96.58 295.73 189.53 Q 293.22 193.50 293.01 195.71 C 292.55 200.60 296.74 205.58 301.51 205.58 Q 403.17 205.65 405.47 205.57 C 410.18 205.43 414.68 206.67 416.22 211.27 Q 418.13 217.00 414.94 220.44 Q 366.28 272.98 149.12 507.37 Q 145.54 511.24 141.80 512.00 L 140.09 512.00 Q 133.33 510.39 132.18 505.27 Q 131.50 502.28 133.92 494.56 Q 154.89 427.39 186.53 325.52 C 188.52 319.11 184.20 313.29 177.53 313.29 Q 113.93 313.24 110.15 313.32 Q 101.28 313.52 99.28 311.96 C 94.32 308.09 94.61 304.57 96.24 298.17 Q 98.55 289.09 167.92 12.79 C 169.65 5.89 170.15 1.66 176.88 0.00 L 400.39 0.00 Z"/></svg></span> å®æ—¶åŒæ­¥æ¨¡å¼';
        document.getElementById('modeSubtitle').textContent = 'è‡ªåŠ¨æ£€æµ‹å¹¶åŒæ­¥æ–°æˆªå›¾';
        document.getElementById('stopBtn').style.display = 'block';
        document.getElementById('syncBtn').style.display = 'none';
        document.getElementById('infoBox').style.display = 'none';

        // é€šçŸ¥Macç«¯å¯åŠ¨å®æ—¶æ¨¡å¼
        if (ws && ws.readyState === 1) {
          ws.send(JSON.stringify({ type: 'start-realtime' }));
          log('âš¡ å®æ—¶åŒæ­¥å·²å¯åŠ¨');
          updateStatus('connected', 'å®æ—¶ç›‘å¬ä¸­');
        }
      } else {
        document.getElementById('modeTitle').innerHTML = '<span class="mode-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="20" height="20"><g><path d="m214.2 107-40.2-29.9c-9.5-7-20.9-10.8-32.7-10.8h-110.2c-16.6 0-30 13.4-30 30v349.5h404.1c15.2 0 27.4-12.3 27.4-27.4v-270.6c0-16.6-13.4-30-30-30h-155.6c-11.8 0-23.3-3.8-32.8-10.8z" fill="#f6c012"/><g><path d="m76.9 143.7h300c8.3 0 15 6.7 15 15v200c0 8.3-6.7 15-15 15h-300c-8.3 0-15-6.7-15-15v-200c0-8.3 6.7-15 15-15z" fill="#ffeac5"/><path d="m56.9 163.7h300c8.3 0 15 6.7 15 15v200c0 8.3-6.7 15-15 15h-300c-8.3 0-15-6.7-15-15v-200c0-8.3 6.7-15 15-15z" fill="#fff7e6"/></g><path d="m85.2 220.1-84.1 225.6h410.8c12.5 0 23.7-7.8 28.1-19.5l69-185.2c7.3-19.6-7.2-40.5-28.1-40.5h-367.6c-12.5.1-23.7 7.8-28.1 19.6z" fill="#fbd87c"/></g></svg></span> æ‰‹åŠ¨åŒæ­¥æ¨¡å¼';
        document.getElementById('modeSubtitle').textContent = 'æ‰¹é‡åŒæ­¥å­˜å‚¨çš„æ‰€æœ‰æˆªå›¾';
        document.getElementById('syncBtn').style.display = 'block';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('infoBox').style.display = 'none';
        updateStatus('connected', 'å·²è¿æ¥');
      }
    }

    function showModeSelection() {
      // åœæ­¢å®æ—¶æ¨¡å¼
      if (currentMode === 'realtime' && ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stop-realtime' }));
        log('â¸ï¸  å®æ—¶åŒæ­¥å·²åœæ­¢');
      }

      // æ¸…é›¶å·²åŒæ­¥æˆªå›¾è®¡æ•°å’Œæ‰‹åŠ¨å¯¼å…¥è®¡æ•°
      screenshotCount = 0;
      manualDragCount = 0;
      document.getElementById('count').textContent = '0';

      currentMode = null;
      document.getElementById('workArea').classList.remove('active');
      document.getElementById('modeSelection').classList.remove('hidden');
      updateStatus('waiting', 'å·²è¿”å›æ¨¡å¼é€‰æ‹©');
    }

    // ========== æŒ‰é’®äº‹ä»¶ ==========
    document.getElementById('realtimeBtn').onclick = function () { showWorkArea('realtime'); };
    document.getElementById('manualBtn').onclick = function () { showWorkArea('manual'); };

    document.getElementById('syncBtn').onclick = function () {
      log('ğŸ«³ğŸ» å¼€å§‹åŒæ­¥...');
      updateStatus('syncing', 'æ­£åœ¨åŒæ­¥');
      
      // æ¸…é›¶æ‰‹åŠ¨æ‹–å…¥è®¡æ•°ï¼Œå¼€å§‹æ–°çš„åŒæ­¥å‘¨æœŸ
      manualDragCount = 0;

      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'manual-sync' }));
      } else {
        log('âŒ æœªè¿æ¥');
        updateStatus('waiting', 'è¿æ¥å¤±è´¥');
      }
    };

    document.getElementById('stopBtn').onclick = function () {
      if (confirm('ç¡®å®šè¦åœæ­¢å®æ—¶åŒæ­¥å—ï¼Ÿ')) { showModeSelection(); }
    };

    // åœæ­¢å®æ—¶åŒæ­¥çš„é€šç”¨å‡½æ•°
    function stopRealtimeSync() {
      if (currentMode === 'realtime' && ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stop-realtime' }));
        log('â¸ï¸  å®æ—¶åŒæ­¥å·²åœæ­¢');
      }
    }

    document.getElementById('locateFrameBtn').onclick = function () {
      parent.postMessage({ pluginMessage: { type: 'locate-frame' } }, '*');
    };

    document.getElementById('backBtn').onclick = function () { 
      stopRealtimeSync();
      showModeSelection(); 
    };

    // ========== åŠ è½½äºŒç»´ç å›¾ç‰‡ ==========
    // æ ¹æ®ä¸»é¢˜åŠ¨æ€é€‰æ‹©äºŒç»´ç 
    function setQRCodeImages() {
      const qrGoogleScreenshot = document.getElementById('qrGoogleScreenshot');
      const qrGoogleAlbum = document.getElementById('qrGoogleAlbum');
      const qrIcloudScreenshot = document.getElementById('qrIcloudScreenshot');
      const qrIcloudAlbum = document.getElementById('qrIcloudAlbum');
      
      // æ£€æµ‹å½“å‰ä¸»é¢˜ï¼ˆdark æˆ– lightï¼‰
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const uris = getQRCodeURI(isDark);
      
      // è®¾ç½®äºŒç»´ç å›¾ç‰‡
      if (qrGoogleScreenshot) qrGoogleScreenshot.src = uris.googleScreenshot || uris.google;
      if (qrGoogleAlbum) qrGoogleAlbum.src = uris.googleAlbum || uris.google;
      if (qrIcloudScreenshot) qrIcloudScreenshot.src = uris.icloudScreenshot || uris.icloud;
      if (qrIcloudAlbum) qrIcloudAlbum.src = uris.icloudAlbum || uris.icloud;
    }

    // ========== æ›´æ–°å›¾æ ‡é¢œè‰²ä»¥é€‚é…ä¸»é¢˜ ==========
    function updateIconColors() {
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      // è·å–æ‰€æœ‰éœ€è¦é€‚é…çš„å•è‰²å›¾æ ‡ï¼ˆæ’é™¤å½©è‰²å›¾æ ‡ï¼‰
      const monochromeIcons = document.querySelectorAll('.text-link img, .logo-icon img');
      
      monochromeIcons.forEach(icon => {
        // å¦‚æœå›¾æ ‡æœ‰ no-invert ç±»ï¼Œè·³è¿‡ï¼ˆç”¨äºå½©è‰²å›¾æ ‡ï¼‰
        if (icon.classList.contains('no-invert')) {
          return;
        }
        
        // åœ¨ dark mode ä¸‹åè½¬é¢œè‰²ï¼Œåœ¨ light mode ä¸‹æ¢å¤
        if (isDark) {
          icon.style.filter = 'invert(1) brightness(1)';
        } else {
          icon.style.filter = 'none';
        }
      });
    }

    // ä¸»é¢˜å˜åŒ–å¤„ç†å‡½æ•°
    function handleThemeChange() {
      setQRCodeImages();
      updateIconColors();
    }
    
    // DOM åŠ è½½å®Œæˆåè®¾ç½®äºŒç»´ç å›¾ç‰‡å’Œå›¾æ ‡é¢œè‰²
    if (document.readyState === 'loading') {
      window.addEventListener('DOMContentLoaded', function() {
        handleThemeChange();
      });
    } else {
      handleThemeChange();
    }
    
    // ç›‘å¬ä¸»é¢˜å˜åŒ–
    const themeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    themeMediaQuery.addEventListener('change', handleThemeChange);

    // ========== ä½¿ç”¨åœºæ™¯ Modal ==========
    const useCaseOverlay = document.getElementById('useCaseOverlay');
    const viewUseCases = document.getElementById('viewUseCases');
    const useCaseClose = document.getElementById('useCaseClose');

    function openUseCases() {
      // å¦‚æœå½“å‰æ˜¯æœ€å°åŒ–çŠ¶æ€ï¼Œå…ˆæ¢å¤
      if (isMinimized) {
        toggleMinimize();
      }
      useCaseOverlay.classList.remove('hidden');
    }

    function closeUseCases() {
      useCaseOverlay.classList.add('hidden');
    }

    viewUseCases.onclick = openUseCases;
    useCaseClose.onclick = closeUseCases;
    useCaseOverlay.addEventListener('click', function (e) {
      if (e.target === useCaseOverlay) closeUseCases();
    });
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && !useCaseOverlay.classList.contains('hidden')) {
        closeUseCases();
      }
    });

    // ========== è®¾ç½® Modal ==========
    const settingsOverlay = document.getElementById('settingsOverlay');
    const openSettingsBtn = document.getElementById('openSettings');
    const settingsClose = document.getElementById('settingsClose');
    const switchToDrive = document.getElementById('switchToDrive');
    const switchToAliyun = document.getElementById('switchToAliyun');
    const switchToIcloud = document.getElementById('switchToIcloud');
    const imageWidthInput = document.getElementById('imageWidthInput');
    const imageHeightInput = document.getElementById('imageHeightInput');
    const saveSizeSettingsBtn = document.getElementById('saveSizeSettings');
    const clearSizeSettingsBtn = document.getElementById('clearSizeSettings');
    const sizeSettingsStatus = document.getElementById('sizeSettingsStatus');
    const frameColumnsInput = document.getElementById('frameColumnsInput');
    const saveLayoutSettingsBtn = document.getElementById('saveLayoutSettings');
    const clearLayoutSettingsBtn = document.getElementById('clearLayoutSettings');
    const layoutSettingsStatus = document.getElementById('layoutSettingsStatus');
    const toggleMinimizeBtn = document.getElementById('toggleMinimize');
    const minimizeIcon = document.getElementById('minimizeIcon');
    const appRoot = document.querySelector('.app');
    
    // å°ºå¯¸è®¾ç½®ï¼šä» Figma clientStorage è¯»å–ï¼ˆé€šè¿‡æ¶ˆæ¯ä¼ é€’ï¼‰
    function loadSizeSettings() {
      // è¯·æ±‚ Figma ç«¯è¯»å–è®¾ç½®
      parent.postMessage({
        pluginMessage: {
          type: 'get-size-settings'
        }
      }, '*');
    }
    
    // å°ºå¯¸è®¾ç½®ï¼šä¿å­˜åˆ° Figma clientStorageï¼ˆé€šè¿‡æ¶ˆæ¯ä¼ é€’ï¼‰
    function saveSizeSettings() {
      const width = imageWidthInput.value.trim();
      const height = imageHeightInput.value.trim();
      
      // éªŒè¯è¾“å…¥
      if (width && (isNaN(width) || parseInt(width) <= 0)) {
        sizeSettingsStatus.textContent = 'âŒ å®½åº¦å¿…é¡»æ˜¯å¤§äº0çš„æ•°å­—';
        sizeSettingsStatus.style.color = 'var(--danger)';
        return;
      }
      if (height && (isNaN(height) || parseInt(height) <= 0)) {
        sizeSettingsStatus.textContent = 'âŒ é«˜åº¦å¿…é¡»æ˜¯å¤§äº0çš„æ•°å­—';
        sizeSettingsStatus.style.color = 'var(--danger)';
        return;
      }
      
      // æ³¨æ„ï¼šå¦‚æœåªè¾“å…¥äº†å®½åº¦æˆ–é«˜åº¦ï¼Œå¦ä¸€ä¸ªå€¼ä¼šåœ¨æ·»åŠ æˆªå›¾æ—¶æ ¹æ®å®é™…å›¾ç‰‡çš„å®½é«˜æ¯”è‡ªåŠ¨è®¡ç®—
      
      // å‘é€ç»™ Figma ä¿å­˜
      parent.postMessage({
        pluginMessage: {
          type: 'update-size-settings',
          width: width ? parseInt(width) : null,
          height: height ? parseInt(height) : null
        }
      }, '*');
      
      sizeSettingsStatus.textContent = 'â³ æ­£åœ¨ä¿å­˜...';
      sizeSettingsStatus.style.color = 'var(--subtext)';
    }
    
    // æ¸…é™¤å°ºå¯¸è®¾ç½®
    function clearSizeSettings() {
      imageWidthInput.value = '';
      imageHeightInput.value = '';
      
      parent.postMessage({
        pluginMessage: {
          type: 'update-size-settings',
          width: null,
          height: null
        }
      }, '*');
      
      sizeSettingsStatus.textContent = 'âœ… å·²æ¸…é™¤å°ºå¯¸è®¾ç½®ï¼Œå°†ä½¿ç”¨æˆªå›¾å®é™…å°ºå¯¸';
      sizeSettingsStatus.style.color = 'var(--success-fg)';
      setTimeout(() => {
        sizeSettingsStatus.textContent = '';
      }, 2000);
    }
    
    // ä¸å†å®æ—¶è‡ªåŠ¨è®¡ç®—ï¼Œåªåœ¨ä¿å­˜æ—¶è®¡ç®—
    
    saveSizeSettingsBtn.onclick = saveSizeSettings;
    clearSizeSettingsBtn.onclick = clearSizeSettings;
    
    // å¸ƒå±€è®¾ç½®ï¼šä» Figma clientStorage è¯»å–ï¼ˆé€šè¿‡æ¶ˆæ¯ä¼ é€’ï¼‰
    function loadLayoutSettings() {
      // è¯·æ±‚ Figma ç«¯è¯»å–è®¾ç½®
      parent.postMessage({
        pluginMessage: {
          type: 'get-layout-settings'
        }
      }, '*');
    }
    
    // å¸ƒå±€è®¾ç½®ï¼šä¿å­˜åˆ° Figma clientStorageï¼ˆé€šè¿‡æ¶ˆæ¯ä¼ é€’ï¼‰
    function saveLayoutSettings() {
      const columns = frameColumnsInput.value.trim();
      
      // éªŒè¯è¾“å…¥
      if (columns && (isNaN(columns) || parseInt(columns) <= 0)) {
        layoutSettingsStatus.textContent = 'âŒ æ¯è¡Œæ˜¾ç¤ºæ•°é‡å¿…é¡»æ˜¯å¤§äº0çš„æ•°å­—';
        layoutSettingsStatus.style.color = 'var(--danger)';
        return;
      }
      
      // å‘é€ç»™ Figma ä¿å­˜
      parent.postMessage({
        pluginMessage: {
          type: 'update-layout-settings',
          columns: columns ? parseInt(columns) : null
        }
      }, '*');
      
      layoutSettingsStatus.textContent = 'â³ æ­£åœ¨ä¿å­˜...';
      layoutSettingsStatus.style.color = 'var(--subtext)';
    }
    
    // æ¸…é™¤å¸ƒå±€è®¾ç½®
    function clearLayoutSettings() {
      frameColumnsInput.value = '';
      
      parent.postMessage({
        pluginMessage: {
          type: 'update-layout-settings',
          columns: null
        }
      }, '*');
      
      layoutSettingsStatus.textContent = 'âœ… å·²æ¸…é™¤å¸ƒå±€è®¾ç½®ï¼Œå°†ä¸€ç›´æ¨ªç€æ’ï¼ˆä¸æ¢è¡Œï¼‰';
      layoutSettingsStatus.style.color = 'var(--success-fg)';
      setTimeout(() => {
        layoutSettingsStatus.textContent = '';
      }, 2000);
    }
    
    saveLayoutSettingsBtn.onclick = saveLayoutSettings;
    clearLayoutSettingsBtn.onclick = clearLayoutSettings;
    
    // æ‰“å¼€è®¾ç½®æ—¶åŠ è½½ä¿å­˜çš„å°ºå¯¸è®¾ç½®å’Œå¸ƒå±€è®¾ç½®
    openSettingsBtn.onclick = function() {
      // å¦‚æœå½“å‰æ˜¯æœ€å°åŒ–çŠ¶æ€ï¼Œå…ˆæ¢å¤
      if (isMinimized) {
        toggleMinimize();
      }
      updateSyncModeDisplay();
      loadSizeSettings();
      loadLayoutSettings();
      settingsOverlay.classList.remove('hidden');
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'get-sync-mode' }));
      }
    };

    function closeSettings() {
      // ç«‹å³éšè—æ¨¡æ€æ¡†
      settingsOverlay.classList.add('hidden');
      document.getElementById('switchStatus').textContent = '';
    }

    function updateSyncModeDisplay() {
      const driveBtn = document.getElementById('switchToDrive');
      const aliyunBtn = document.getElementById('switchToAliyun');
      const icloudBtn = document.getElementById('switchToIcloud');
      
      // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
      driveBtn.classList.remove('selected');
      aliyunBtn.classList.remove('selected');
      icloudBtn.classList.remove('selected');
      
      // æ ¹æ®å½“å‰æ¨¡å¼æ·»åŠ é€‰ä¸­çŠ¶æ€
      if (currentSyncMode === 'drive') {
        driveBtn.classList.add('selected');
      } else if (currentSyncMode === 'aliyun' || currentSyncMode === 'oss') {
        aliyunBtn.classList.add('selected');
      } else if (currentSyncMode === 'icloud') {
        icloudBtn.classList.add('selected');
      }
    }

    settingsClose.onclick = closeSettings;
    settingsOverlay.addEventListener('click', function (e) {
      if (e.target === settingsOverlay) closeSettings();
    });
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && !settingsOverlay.classList.contains('hidden')) {
        closeSettings();
      }
    });

    // åˆ‡æ¢åŒæ­¥æ¨¡å¼
    switchToDrive.onclick = function () {
      if (currentSyncMode === 'drive') {
        document.getElementById('switchStatus').textContent = 'â„¹ï¸ å·²ç»æ˜¯ Google Drive ä¸Šä¼ æ¨¡å¼';
        document.getElementById('switchStatus').style.color = 'var(--subtext)';
        return;
      }
      document.getElementById('switchStatus').textContent = 'â³ æ­£åœ¨åˆ‡æ¢...';
      document.getElementById('switchStatus').style.color = 'var(--subtext)';
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'switch-sync-mode', mode: 'drive' }));
      } else {
        document.getElementById('switchStatus').textContent = 'âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨';
        document.getElementById('switchStatus').style.color = 'var(--danger)';
      }
    };

    switchToAliyun.onclick = function () {
      if (currentSyncMode === 'aliyun' || currentSyncMode === 'oss') {
        document.getElementById('switchStatus').textContent = 'â„¹ï¸ å·²ç»æ˜¯é˜¿é‡Œäº‘ OSS ä¸Šä¼ æ¨¡å¼';
        document.getElementById('switchStatus').style.color = 'var(--subtext)';
        return;
      }
      document.getElementById('switchStatus').textContent = 'â³ æ­£åœ¨åˆ‡æ¢...';
      document.getElementById('switchStatus').style.color = 'var(--subtext)';
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'switch-sync-mode', mode: 'aliyun' }));
      } else {
        document.getElementById('switchStatus').textContent = 'âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨';
        document.getElementById('switchStatus').style.color = 'var(--danger)';
      }
    };

    switchToIcloud.onclick = function () {
      if (currentSyncMode === 'icloud') {
        document.getElementById('switchStatus').textContent = 'â„¹ï¸ å·²ç»æ˜¯ iCloud ä¸Šä¼ æ¨¡å¼';
        document.getElementById('switchStatus').style.color = 'var(--subtext)';
        return;
      }
      document.getElementById('switchStatus').textContent = 'â³ æ­£åœ¨åˆ‡æ¢...';
      document.getElementById('switchStatus').style.color = 'var(--subtext)';
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'switch-sync-mode', mode: 'icloud' }));
      } else {
        document.getElementById('switchStatus').textContent = 'âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨';
        document.getElementById('switchStatus').style.color = 'var(--danger)';
      }
    };

    // ========== æœ€å°åŒ–/æ¢å¤åŠŸèƒ½ ==========
    function toggleMinimize() {
      isMinimized = !isMinimized;
      
      // è·å–å½“å‰å›¾æ ‡å…ƒç´ ï¼ˆæ¯æ¬¡é‡æ–°è·å–ï¼Œé¿å…å¼•ç”¨å¤±æ•ˆï¼‰
      const currentIcon = document.getElementById('minimizeIcon');
      if (!currentIcon) return; // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
      
      if (isMinimized) {
        // æœ€å°åŒ–ï¼šåªæ˜¾ç¤º toolbar
        appRoot.classList.add('minimized');
        // å…³é—­æ‰€æœ‰å¼¹çª—
        settingsOverlay.classList.add('hidden');
        useCaseOverlay.classList.add('hidden');
        // æ›´æ–°å›¾æ ‡ä¸ºæœ€å¤§åŒ–å›¾æ ‡ï¼ˆmaximize.svgï¼‰- ä½¿ç”¨ img src æ›¿æ¢
        currentIcon.src = IMAGE_BASE_URL + 'maximize.svg';
        toggleMinimizeBtn.setAttribute('title', 'æ¢å¤');
        
        // è°ƒæ•´çª—å£å¤§å°åˆ°æœ€å°ï¼ˆåªæ˜¾ç¤º toolbarï¼‰
        // toolbar é«˜åº¦å¤§çº¦ 60px
        parent.postMessage({
          pluginMessage: {
            type: 'resize',
            width: 480,
            height: 60
          }
        }, '*');
      } else {
        // æ¢å¤ï¼šæ˜¾ç¤ºå®Œæ•´å†…å®¹
        appRoot.classList.remove('minimized');
        // æ›´æ–°å›¾æ ‡ä¸ºæœ€å°åŒ–å›¾æ ‡ï¼ˆminimize.svgï¼‰- ä½¿ç”¨ img src æ›¿æ¢
        currentIcon.src = IMAGE_BASE_URL + 'minimize.svg';
        toggleMinimizeBtn.setAttribute('title', 'æœ€å°åŒ–');
        
        // æ¢å¤çª—å£å¤§å°
        parent.postMessage({
          pluginMessage: {
            type: 'resize',
            width: 480,
            height: 700
          }
        }, '*');
      }
    }

    toggleMinimizeBtn.onclick = toggleMinimize;

    // ========== æ¥æ”¶Figmaæ¶ˆæ¯ ==========
    window.onmessage = function (event) {
      var msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === 'plugin-closing') {
        stopRealtimeSync();
      } else if (msg.type === 'frame-created') {
        log('âœ… ç”»æ¿å·²åˆ›å»º');
      } else if (msg.type === 'frame-located') {
        if (msg.success) {
          log('ğŸ“ ' + msg.message);
        } else {
          log('âŒ ' + msg.message);
        }
      } else if (msg.type === 'screenshot-added') {
        if (msg.success) {
          // åªæœ‰åœ¨æˆåŠŸå¯¼å…¥æ—¶æ‰å¢åŠ è®¡æ•°
          screenshotCount++;
          document.getElementById('count').textContent = screenshotCount;
          
          // ä¸è®°å½•æˆåŠŸæ—¥å¿—ï¼Œé¿å…ä¿¡æ¯è¿‡è½½ï¼ˆå·²åœ¨æ”¶åˆ°æˆªå›¾æ—¶è®°å½•ï¼‰
          // å‘é€ç¡®è®¤æ¶ˆæ¯ç»™Macç«¯ï¼Œè¡¨ç¤ºæ–‡ä»¶å·²æˆåŠŸå¯¼å…¥
          if (ws && ws.readyState === WebSocket.OPEN && currentDriveFileId) {
            try {
              ws.send(JSON.stringify({
                type: 'screenshot-received',
                filename: msg.filename || 'æœªå‘½åæ–‡ä»¶',
                driveFileId: currentDriveFileId,
                timestamp: Date.now()
              }));
              // æˆåŠŸå‘é€ç¡®è®¤åï¼Œæ¸…é™¤ä¿å­˜çš„ driveFileId
              currentDriveFileId = null;
            } catch (error) {
              console.error('å‘é€ç¡®è®¤å¤±è´¥:', error);
            }
          }
        } else {
          log('âŒ æ·»åŠ å¤±è´¥: ' + (msg.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } else if (msg.type === 'file-needs-manual-drag') {
        // undefined é”™è¯¯ï¼šéœ€è¦æ‰‹åŠ¨å¯¼å…¥ï¼Œä¿ç•™æºæ–‡ä»¶
        manualDragCount++;
        const reasonText = msg.reason === 'undefined-error' ? 'å¯¼å…¥å¤±è´¥ï¼ˆundefinedé”™è¯¯ï¼‰' : 'æœªçŸ¥åŸå› ';
        log(`âš ï¸  ${msg.filename} éœ€æ‰‹åŠ¨å¯¼å…¥ï¼ˆ${reasonText}ï¼‰`);
        
        // é€šè¿‡ WebSocket é€šçŸ¥æœåŠ¡å™¨ï¼Œä¸è¦åˆ é™¤æºæ–‡ä»¶
        if (ws && ws.readyState === WebSocket.OPEN) {
          try {
            ws.send(JSON.stringify({
              type: 'screenshot-failed',
              filename: msg.filename,
              driveFileId: currentDriveFileId, // ä½¿ç”¨ä¿å­˜çš„ driveFileId
              error: msg.error || 'undefinedé”™è¯¯',
              keepFile: true // æ ‡è®°ä¿ç•™æ–‡ä»¶
            }));
            // æ¸…é™¤ä¿å­˜çš„ driveFileId
            currentDriveFileId = null;
          } catch (error) {
            console.error('å‘é€å¤±è´¥æ¶ˆæ¯å¤±è´¥:', error);
          }
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        updateStatus('connected', '');
      } else if (msg.type === 'size-settings-loaded') {
        // ä» Figma clientStorage åŠ è½½çš„å°ºå¯¸è®¾ç½®
        if (msg.width) imageWidthInput.value = msg.width;
        if (msg.height) imageHeightInput.value = msg.height;
      } else if (msg.type === 'size-settings-updated') {
        // å°ºå¯¸è®¾ç½®ä¿å­˜æˆåŠŸ
        if (msg.success) {
          sizeSettingsStatus.textContent = 'âœ… å°ºå¯¸è®¾ç½®å·²ä¿å­˜';
          sizeSettingsStatus.style.color = 'var(--success-fg)';
          setTimeout(() => {
            sizeSettingsStatus.textContent = '';
          }, 2000);
        }
      } else if (msg.type === 'layout-settings-loaded') {
        // ä» Figma clientStorage åŠ è½½çš„å¸ƒå±€è®¾ç½®
        if (msg.columns) frameColumnsInput.value = msg.columns;
      } else if (msg.type === 'layout-settings-updated') {
        // å¸ƒå±€è®¾ç½®ä¿å­˜æˆåŠŸ
        if (msg.success) {
          layoutSettingsStatus.textContent = 'âœ… å¸ƒå±€è®¾ç½®å·²ä¿å­˜';
          layoutSettingsStatus.style.color = 'var(--success-fg)';
          setTimeout(() => {
            layoutSettingsStatus.textContent = '';
          }, 2000);
        }
      }
    };

    // ========== æ—¥å¿—å±•å¼€/æ”¶èµ·åŠŸèƒ½ ==========
    const logContainer = document.getElementById('logContainer');
    const logHeader = document.getElementById('logHeader');
    const logToggleText = document.getElementById('logToggleText');
    const logToggleIcon = document.querySelector('.log-toggle-icon');

    // æ”¶èµ·æ—¥å¿—çš„å‡½æ•°
    function collapseLog() {
      logContainer.classList.add('collapsed');
      logToggleText.textContent = 'å±•å¼€';
      logToggleIcon.textContent = 'â–¼';
    }

    // å±•å¼€æ—¥å¿—çš„å‡½æ•°
    function expandLog() {
      logContainer.classList.remove('collapsed');
      logToggleText.textContent = 'æ”¶èµ·';
      logToggleIcon.textContent = 'â–²';
    }

    logHeader.addEventListener('click', function () {
      const isCollapsed = logContainer.classList.contains('collapsed');
      if (isCollapsed) {
        expandLog();
      } else {
        collapseLog();
      }
    });

    // ========== å¯åŠ¨ ==========
    connect();

    // ========== ç›‘å¬æ’ä»¶å…³é—­äº‹ä»¶ ==========
    // å½“ç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’Ã—å…³é—­æ’ä»¶æ—¶ï¼Œç¡®ä¿åœæ­¢å®æ—¶åŒæ­¥
    window.addEventListener('beforeunload', function () {
      stopRealtimeSync();
    });

    // çª—å£é«˜åº¦å›ºå®šï¼Œä¸å†è‡ªé€‚åº”è°ƒæ•´
  </script>
</body>

</html>